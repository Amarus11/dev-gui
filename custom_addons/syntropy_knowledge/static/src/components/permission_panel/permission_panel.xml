<?xml version="1.0" encoding="UTF-8" ?>
<templates>

    <t t-name="syntropy_knowledge.PermissionPanel">
        <div class="o_knowledge_permission_panel p-3" style="min-width: 380px;">

            <!-- Header -->
            <div class="d-flex align-items-center mb-3">
                <h6 class="m-0 fw-bold flex-grow-1">Share &amp; Permissions</h6>
                <button t-if="props.onClose" class="btn-close btn-sm" t-on-click="props.onClose"/>
            </div>

            <t t-if="state.loading">
                <div class="text-center py-3">
                    <i class="fa fa-spinner fa-spin"/>
                </div>
            </t>

            <t t-if="!state.loading and state.data">

                <!-- Internal permission -->
                <div class="mb-3">
                    <label class="form-label small fw-semibold text-muted">Default Access</label>
                    <div class="btn-group w-100" role="group">
                        <t t-foreach="[['write', 'Can edit'], ['read', 'Can view'], ['none', 'No access']]"
                           t-as="perm" t-key="perm[0]">
                            <button t-att-class="'btn btn-sm ' + (state.data.internal_permission === perm[0] ? 'btn-primary' : 'btn-outline-secondary')"
                                    t-on-click="() => this.setInternalPermission(perm[0])">
                                <t t-out="perm[1]"/>
                            </button>
                        </t>
                    </div>
                </div>

                <!-- Members list -->
                <div class="mb-3">
                    <label class="form-label small fw-semibold text-muted d-flex align-items-center">
                        <span class="flex-grow-1">Members</span>
                        <button class="btn btn-link btn-sm p-0" t-on-click="onInviteMembers">
                            <i class="fa fa-plus me-1"/>Invite
                        </button>
                    </label>

                    <t t-if="members.length === 0">
                        <div class="text-muted small py-2">No specific members</div>
                    </t>

                    <t t-foreach="members" t-as="member" t-key="member.id">
                        <div class="d-flex align-items-center py-2 border-bottom">
                            <img t-att-src="member.partner_avatar"
                                 class="rounded-circle me-2"
                                 style="width: 32px; height: 32px; object-fit: cover;"/>
                            <div class="flex-grow-1 text-truncate">
                                <div class="fw-medium small" t-out="member.partner_name"/>
                                <div class="text-muted" style="font-size: 11px;" t-out="member.partner_email"/>
                            </div>
                            <select class="form-select form-select-sm ms-2"
                                    style="width: auto; font-size: 12px;"
                                    t-on-change="(ev) => this.setMemberPermission(member.id, ev.target.value)">
                                <option value="write" t-att-selected="member.permission === 'write'">Can edit</option>
                                <option value="read" t-att-selected="member.permission === 'read'">Can view</option>
                                <option value="none" t-att-selected="member.permission === 'none'">No access</option>
                            </select>
                            <button class="btn btn-link btn-sm text-danger p-0 ms-1"
                                    t-if="!member.is_current_user"
                                    t-on-click="() => this.removeMember(member.id)"
                                    title="Remove member">
                                <i class="fa fa-times"/>
                            </button>
                        </div>
                    </t>
                </div>

                <!-- Department access (HR integration) -->
                <t t-if="viewDepartments.length > 0 or editDepartments.length > 0">
                    <div class="mb-3">
                        <label class="form-label small fw-semibold text-muted">Department Access</label>
                        <t t-foreach="editDepartments" t-as="dept" t-key="dept.id">
                            <div class="d-flex align-items-center py-1">
                                <i class="fa fa-building-o me-2 text-muted"/>
                                <span class="flex-grow-1 small" t-out="dept.name"/>
                                <span class="badge bg-success">Can edit</span>
                            </div>
                        </t>
                        <t t-foreach="viewDepartments" t-as="dept" t-key="dept.id">
                            <div class="d-flex align-items-center py-1">
                                <i class="fa fa-building-o me-2 text-muted"/>
                                <span class="flex-grow-1 small" t-out="dept.name"/>
                                <span class="badge bg-info">Can view</span>
                            </div>
                        </t>
                    </div>
                </t>

                <!-- Share link -->
                <div class="border-top pt-3 mt-2">
                    <div class="d-flex align-items-center">
                        <i class="fa fa-link me-2 text-muted"/>
                        <span class="small flex-grow-1">Share link</span>
                        <button class="btn btn-outline-secondary btn-sm"
                                t-on-click="onCopyShareLink">
                            <i class="fa fa-clipboard me-1"/>Copy
                        </button>
                    </div>
                </div>

            </t>
        </div>
    </t>

</templates>
